import pandas as pd
import matplotlib.pyplot as plt
import os

def autopct(pct): # only show the label when it's > 10%
    return ('%1.1f%%' % pct) if pct > 1 else ''

#Read edited csv
df_lang = pd.read_csv('files_exploit_lang.csv')

#---------------GLOBAL STATISTICS----------------
#Value counts of languages
df_lang_count = df_lang.language.value_counts()
#Global percentage dataset
percentage = (df_lang['language'].value_counts()/df_lang['language'].count())*100
print('Global percentage of snippets languages available in results/global_statistics.csv')
percentage.to_csv(os.path.join('results','global_statistics.csv'))

#---------------WORDPRESS STATISTICS----------------
#Wordpress snippets dataset
df_wp = df_lang[df_lang['description'].str.contains('wordpress', case=False)]
#Value count of language in wp snippets
df_wp_count = df_wp.language.value_counts()
#Wp percentage Dataset
percentage_wp = (df_wp['language'].value_counts()/df_wp['language'].count())*100
print('Percentage of wp snippets languages available in results/wp_statistics.csv')
percentage_wp.to_csv(os.path.join('results','wp_statistics.csv'))

#---------------PLOT PERCENTAGE----------------
fig = plt.figure(figsize=(8,4),dpi=160)
plt.rcParams['font.size'] = 7.0
ax1 = fig.add_subplot(121)
ax1.pie(df_lang_count, labels=df_lang_count.index, autopct=autopct)

ax2 = fig.add_subplot(122)
ax2.pie(df_wp_count, labels=df_wp_count.index, autopct=autopct)

plt.show()
fig.savefig(os.path.join('results','percentage.png'))

#---------------PYTHON DATASET STATISTICS----------------
#Python snippets dataset
df_py = df_lang[df_lang['language']=='py']
#Save python dataset on new csv
df_py.to_csv('python_exploits.csv', index=False)


#---------------RUBY DATASET STATISTICS----------------
#Ruby snippets dataset
df_rb = df_lang[df_lang['language']=='rb']
#Ruby MSF percentage
percentage_mfs_rb = (df_rb['description'].str.contains('metasploit|mfs', case=False).value_counts()/df_rb['description'].count())*100
print('Percentage of mfs ruby snippets: ')
print(percentage_mfs_rb)