# TEST: run PyCRE for each python snippet
import sys
sys.path.append('..')
from core.dependency import py_dependencymanager as dep

import os
import shutil
import pandas as pd


def check_dependencies(snippet_path):
    parsed = False
    snippet = os.path.basename(snippet_path)
    snippet_path = os.path.join('..','exploitdb_repo', snippet_path)
    parent_dir = os.path.join('..','exploits')
    path = os.path.join(parent_dir, snippet)
    if not(os.path.isdir(path)):
        os.mkdir(path)
        print("Directory '%s' created" %snippet)
        shutil.copy(snippet_path, path)

    local_path = os.path.join(path, snippet)

    dep.run(local_path, path)

    #Check if DockerFile and requirements have been successfully generated
    count = 0
    for f in os.listdir(path):
        if os.path.isfile(os.path.join(path, f)):
            count += 1
    if(count==3):
        parsed = True
    
    return parsed


if not(os.path.isdir('../exploits')):
    os.mkdir('../exploits/')

df = pd.read_csv('python_exploits.csv')
df['parsed'] = df['file'].apply(check_dependencies)
df.to_csv('python_exploits.csv', index=False)

#Statistics on version frequency and percentage
plot = df.plot.pie(y='parsed', title="Parsed snippets", autopct='%1.1f%%', legend=False, startangle=0)
plot.show()

print("Done, check output in exploits folder and check csv")