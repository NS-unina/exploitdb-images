# TEST: run PyCRE for each python snippet
import sys
sys.path.append('..')
from core.dependency import py_dependencymanager as dep

import os
import shutil
import pandas as pd
import matplotlib.pyplot as plt
import time

f = open('test_pycre_time.txt', 'w')
start_time = time.time()

def check_dependencies(snippet_path):
    parsed = False
    snippet = os.path.basename(snippet_path)
    print('Checking dependency for: ',snippet)
    snippet_path_source = os.path.join('..','exploit_db_repo', snippet_path)
    path = os.path.join('..','images', snippet_path)
    if not(os.path.isdir(path)):
        os.makedirs(path)
        print("Directory '%s' created" %snippet)
    
    local_path = os.path.join(path, snippet)
    if not (os.path.exists(local_path)):
        shutil.copy(snippet_path_source, path)
    
    res = dep.run(local_path, path)

    #Check if dependency has been generated correctly
    parsed = False
    if(res['python']!=None):
        parsed = True
    return parsed


df = pd.read_csv('python_exploits.csv')
df['parsed'] = df['file'].apply(check_dependencies)
df.to_csv('python_exploits.csv', index=False)

f.write('Execution time: '+str(time.time()-start_time))
f.close

#Plot
fig = plt.figure()
ax = fig.add_subplot()
df_parsed_count = df.parsed.value_counts()
ax.pie(df_parsed_count, labels=df_parsed_count.index, autopct='%1.1f%%')
fig.savefig(os.path.join('results','parsed.png'))

print("Done, check output in exploits folder and check csv")