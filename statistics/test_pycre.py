# TEST: run PyCRE for each python snippet

import os
import subprocess

py_snippets = open("py_snippets.txt", "r")
not_parsed = 0
parsed = 0

for riga in py_snippets:
    snippet_path = riga.strip()
    snippet = os.path.basename(snippet_path) 
    parent_dir = "../exploits/"
    path = os.path.join(parent_dir, snippet)
    if not(os.path.isdir(path)):
        os.mkdir(path)
        print("Directory '%s' created" %snippet)

    cmd = "python run.py "+ snippet_path + " "+ path + "/"
    subprocess.run(cmd, shell=True)  

    #Check if folder is empty or not: if it is, the snippet can't be parsed
    if (os.path.isdir(path)):
        if len(os.listdir(path)) == 0:
            not_parsed+=1
        else:
            parsed+=1

print("Done, check output in exploits folder")


#After running PyCRE for each script, check how many folders are not empty (contains requirements.txt and Dockerfile) -----> INGLOBED IN FIRST FOR CYCLE
#for riga in py_snippets:
#    snippet_path = riga.strip()
#    snippet = os.path.basename(snippet_path)
#    parent_dir = "../exploits/"
#    path = os.path.join(parent_dir, snippet)
#    if (os.path.isdir(path)):
#        if len(os.listdir(path)) == 0:
#            not_parsed+=1
#        else:
#            parsed+=1


parsed_percentage_results = open("parsed_percentage_results.txt", "w")

perc_parsed = 100 * float(parsed)/float(parsed+not_parsed)
perc_not_parsed = 100.0 - perc_parsed

print("Total snippet parsed: " + str(parsed) + " Percentage: " + str(perc_parsed) + "%")
parsed_percentage_results.write("Total snippet parsed: " + str(parsed) + " Percentage: " + str(perc_parsed) + "%" + "\n")
print("Total snippet not parsed: "+ str(not_parsed) + " Percentage: " + str(perc_not_parsed) + "%")
parsed_percentage_results.write("Total snippet not parsed: "+ str(not_parsed) + " Percentage: " + str(perc_not_parsed) + "%" + "\n")

py_snippets.close()
parsed_percentage_results.close()