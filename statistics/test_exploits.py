import sys
sys.path.append('..')
from core.imagemanager import dockermanager
from core.dependency import py_dependencymanager as dep

import pandas as pd
import matplotlib.pyplot as plt
import os
import shutil
import time


def check_dependencies(snippet_path):
    parsed = False
    snippet = os.path.basename(snippet_path)
    print('Checking dependency for: ',snippet)
    print("SNIPPETH PATH ",snippet_path)
    snippet_path_source = os.path.join('..','exploit_db_repo', snippet_path)
    print("SNIPPET PATH SOURCE ", snippet_path_source)
    path = os.path.join('..','images', snippet_path)
    print("PATH", path)
    if not(os.path.isdir(path)):
        os.makedirs(path)
        print("Directory '%s' created" %snippet)
    local_path = os.path.join(path, snippet)
    if not (os.path.exists(local_path)):
        shutil.copy(snippet_path_source, path)

    res = dep.run(local_path, path)

    #Check if dependency has been generated correctly
    parsed = False
    if(res['python']!=None):
        parsed = True
    return parsed

def test(file):
    result = "Not parsed"
    parsed = check_dependencies(file)
    if(parsed):
        path = os.path.join('..', 'images',file)
        result = dockermanager.test_exploit(path)
    return result

f = open('test_pycre_time.txt', 'w')
start_time = time.time()

#Read csv
df = pd.read_csv('python_exploits.csv')

#Add new column for exit_code
df['exit_code'] = df['file'].apply(test)

#Save edited dataset on new csv
df_test = df[['id', 'exit_code']]
path_test_csv = os.path.join('results', 'exit_code.csv')
df_test.to_csv(path_test_csv, index=False)

percentage = (df_test['exit_code'].value_counts()/df_test['exit_code'].count())*100
print('Percentage of exit_codes: ')
print(percentage)
percentage.to_csv(os.path.join('results','exit_code_statistics.csv'))

f.write('Execution time: '+str(time.time()-start_time))
f.close

#Plot of exit codes
#plt = df_test.plt.pie(y='exit_code', title="Exit codes", autopct='%1.1f%%', legend=False, startangle=0)
#plt.savefig(os.path.join('result','exit_code_plot.png'))

